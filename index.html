<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Paper Reader</title>
  <style>
    :root {
      --bg: #0f172a;
      --text: #f8fafc;
      --primary: #3b82f6;
      --muted: #94a3b8;
      --border: #334155;
      --card-bg: #1e293b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 220px;
      background-color: var(--card-bg);
      border-right: 1px solid var(--border);
      padding: 1rem;
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--primary);
    }

    .topic-link {
      display: block;
      padding: 0.5rem 0.75rem;
      color: var(--muted);
      border-radius: 6px;
      text-decoration: none;
      transition: background 0.2s, color 0.2s;
    }

    .topic-link:hover,
    .topic-link.active {
      background-color: #1e40af;
      color: var(--text);
      font-weight: 600;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: hidden;
    }

    .toolbar {
      padding: 0.75rem 1rem;
      background: transparent;
      display: flex;
      justify-content: flex-end;
    }

    .toolbar select {
      background-color: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--primary);
      border-radius: 6px;
      padding: 0.4rem 0.6rem;
      font-size: 0.9rem;
      appearance: none;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s, background-color 0.2s;
    }

    .toolbar select:hover {
      border-color: #60a5fa;
      background-color: #1e3a8a;
    }


    .content-area {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    .topic-section {
      margin-bottom: 3rem;
    }

    .topic-section h2 {
      font-size: 1.4rem;
      color: var(--primary);
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.25rem;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: box-shadow 0.2s;
    }

    .card:hover {
      box-shadow: 0 2px 12px rgba(255, 255, 255, 0.05);
    }

    .card h4 {
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .subtopics {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }

    .info {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }

    .card a {
      margin-top: auto;
      padding: 0.4rem 0.75rem;
      background-color: var(--primary);
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 0.85rem;
      text-align: center;
      transition: background 0.2s;
    }

    .card a:hover {
      background-color: #2563eb;
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }

      .main {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>

  <div class="sidebar" id="sidebar">
    <h2>Topics</h2>
    <div id="topics"></div>
  </div>

  <div class="main">
    <div class="toolbar">
      <select id="sortSubtopic">
        <option value="none">Default</option>
        <option value="subtopic-asc">Subtopics A‚ÄìZ</option>
        <option value="subtopic-desc">Subtopics Z‚ÄìA</option>
      </select>
    </div>
    <div class="content-area" id="content">Loading...</div>
  </div>

  <script>
    async function loadCSV(path) {
      const res = await fetch(path);
      const text = await res.text();
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',');

      return lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
        return obj;
      });
    }

    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleString();
    }

    function getProgress(key) {
      const data = localStorage.getItem('progress_' + key);
      return data ? JSON.parse(data) : null;
    }

    function groupByTopic(papers) {
      const grouped = {};
      papers.forEach(p => {
        const topic = p.topic?.trim() || 'Other';
        if (!grouped[topic]) grouped[topic] = [];
        grouped[topic].push(p);
      });
      return grouped;
    }

    function renderSidebar(grouped, activeTopic) {
      const sidebar = document.getElementById('topics');
      sidebar.innerHTML = '';

      Object.keys(grouped).sort().forEach(topic => {
        const link = document.createElement('a');
        link.href = '#';
        link.textContent = topic;
        link.className = 'topic-link' + (topic === activeTopic ? ' active' : '');
        link.onclick = (e) => {
          e.preventDefault();
          renderContent(grouped, topic);
          renderSidebar(grouped, topic);
        };
        sidebar.appendChild(link);
      });
    }

    function renderContent(grouped, selectedTopic = null) {
      const container = document.getElementById('content');
      container.innerHTML = '';

      const topics = selectedTopic ? [selectedTopic] : Object.keys(grouped);
      const sortMode = document.getElementById('sortSubtopic')?.value || 'none';

      topics.forEach(topic => {
        const section = document.createElement('div');
        section.className = 'topic-section';

        const header = document.createElement('h2');
        header.textContent = topic;
        section.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'grid';

        let topicPapers = [...grouped[topic]];

        if (sortMode === 'subtopic-asc' || sortMode === 'subtopic-desc') {
          topicPapers.sort((a, b) => {
            const aSub = a.subtopics?.split(';')[0].trim().toLowerCase() || '';
            const bSub = b.subtopics?.split(';')[0].trim().toLowerCase() || '';
            return sortMode === 'subtopic-asc'
              ? aSub.localeCompare(bSub)
              : bSub.localeCompare(aSub);
          });
        }

        topicPapers.forEach(paper => {
          const card = document.createElement('div');
          card.className = 'card';

          const title = document.createElement('h4');
          title.textContent = paper.filename;
          card.appendChild(title);

          const subtopics = (paper.subtopics || 'General')
            .split(';')
            .map(t => t.trim())
            .filter(Boolean);

          const subtopicsEl = document.createElement('div');
          subtopicsEl.className = 'subtopics';
          subtopicsEl.textContent = 'üìå ' + subtopics.join(', ');
          card.appendChild(subtopicsEl);

          const progress = getProgress(paper.path);
          const info = document.createElement('div');
          info.className = 'info';
          info.textContent = progress
            ? `Last read: ${formatDate(progress.lastRead)} ‚Ä¢ ${progress.percent}%`
            : 'Not started';
          card.appendChild(info);

          const link = document.createElement('a');
          link.href = `reader.html?file=${encodeURIComponent(paper.path)}&name=${encodeURIComponent(paper.filename)}`;
          link.textContent = 'Open PDF';
          card.appendChild(link);

          grid.appendChild(card);
        });

        section.appendChild(grid);
        container.appendChild(section);
      });
    }

    let groupedPapers = {};

    loadCSV('papers.csv')
      .then(papers => {
        groupedPapers = groupByTopic(papers);
        renderSidebar(groupedPapers);
        renderContent(groupedPapers);

        document.getElementById('sortSubtopic').addEventListener('change', () => {
          const activeTopic = document.querySelector('.topic-link.active')?.textContent;
          renderContent(groupedPapers, activeTopic);
        });
      })
      .catch(err => {
        document.getElementById('content').textContent = '‚ö†Ô∏è Failed to load papers.csv';
        console.error(err);
      });
  </script>
</body>
</html>
